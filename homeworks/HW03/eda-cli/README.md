# HW03 — мини‑приложение EDA CLI

Домашнее задание к семинару S03: консольное приложение для разведочного анализа данных (EDA) на `pandas` + `matplotlib` с CLI на `typer`.

---

## 1. Цель работы

- Попрактиковаться в структуре проекта на `uv` (`pyproject.toml + src/`‑layout).
- Оформить EDA‑логику в виде переиспользуемых функций и модулей.
- Расширить готовый проект:
  - добавить несколько эвристик качества данных;
  - параметризовать команду `report`;
  - покрыть новую логику минимальными тестами;
  - реализовать дополнительные CLI‑команды и артефакты (доп. часть).

---

## 2. Окружение

- Python 3.12
- `uv` как менеджер проекта и зависимостей
- ОС: Windows (запуск в PowerShell / PyCharm)

Перед началом работы нужно, чтобы команда:

```bash
uv --version
```

корректно отрабатывала в терминале.

---

## 3. Структура проекта

Проект лежит в папке:

```text
homeworks/
  HW03/
    eda-cli/
      pyproject.toml
      uv.lock
      README.md
      .gitignore
      src/
        eda_cli/
          __init__.py
          core.py
          viz.py
          cli.py
      tests/
        test_core.py
      data/
        example.csv
      .venv/              # локальное окружение (не коммитится)
      reports_example/    # примеры отчётов (не коммитятся)
      reports_custom/
```

---

## 4. Установка зависимостей

Из корня проекта `eda-cli`:

```bash
cd homeworks/HW03/eda-cli
uv sync
```

Команда создаст виртуальное окружение `.venv` и установит все зависимости, зафиксированные в `pyproject.toml` и `uv.lock`.

---

## 5. CLI‑интерфейс

Проект предоставляет несколько CLI‑команд через точку входа `eda-cli`.

Общий шаблон запуска:

```bash
uv run eda-cli <команда> <аргументы> [опции]
```

### 5.1. Команда `overview`

Краткий обзор датасета: размеры, типы данных, базовая информация о пропусках.

**Синтаксис:**

```bash
uv run eda-cli overview PATH [опции]
```

**Основные параметры:**

- `PATH` — путь к CSV‑файлу (например, `data/example.csv`);
- `--sep`, `-s` — разделитель в CSV (по умолчанию `,`);
- `--encoding`, `-e` — кодировка (по умолчанию `utf-8`).

**Пример:**

```bash
uv run eda-cli overview data/example.csv
```

В консоль выводятся:

- количество строк и колонок;
- общий объём памяти;
- число пропусков и колонок с пропусками;
- типы данных по столбцам.

---

### 5.2. Команда `report`

Генерирует полный EDA‑отчёт в указанную директорию: Markdown‑отчёт + графики. Команда доработана в рамках ДЗ: добавлены новые параметры, влияющие на содержимое отчёта и пороги эвристик.

**Синтаксис:**

```bash
uv run eda-cli report PATH [опции]
```

где `PATH` — путь к CSV‑файлу.

**Основные опции:**

| Опция | Описание | По умолчанию |
|-------|----------|--------------|
| `--out-dir`, `-o` | Папка для сохранения отчёта | `reports` |
| `--sep`, `-s` | Разделитель CSV | `,` |
| `--encoding`, `-e` | Кодировка файла | `utf-8` |
| `--max-hist-columns` | Максимум числовых колонок для гистограмм и boxplot | `6` |
| `--top-k-categories` | Сколько top‑значений выводить для категориальных признаков | `5` |
| `--title`, `-t` | Заголовок отчёта (`# ...` в начале `report.md`) | `EDA Report` |
| `--min-missing-share` | Порог доли пропусков, при превышении которого колонка попадает в список проблемных | `0.1` |
| `--json-summary` | Если указано, дополнительно сохраняется `summary.json` с краткой сводкой | `False` |

**Влияние новых параметров:**

- `--max-hist-columns`  
  Ограничивает число числовых колонок, для которых строятся гистограммы (`histograms.png`) и boxplot‑график (`boxplots.png`). Если числовых признаков больше, в отчёт попадают только первые N.

- `--top-k-categories`  
  Определяет число наиболее частых категорий:
  - в текстовом описании категориальных колонок (раздел «Категориальные признаки»);
  - в дополнительном bar‑chart для первой категориальной колонки.

- `--title`  
  Используется как заголовок первого уровня в `report.md` и позволяет быстро подписывать отчёты под конкретный датасет или эксперимент.

- `--min-missing-share`  
  Задаёт порог отнесения колонки к «проблемным» по пропускам. Колонки с долей пропусков ≥ порога выводятся отдельным списком в разделе «Проблемные колонки (по пропускам)» вместе с долей и количеством пропусков.

- `--json-summary`  
  При присутствии флага, помимо `report.md` и картинок, создаётся `summary.json` со сводной информацией:
  - размеры датасета (`n_rows`, `n_cols`);
  - интегральный `quality_score`;
  - общее количество пропусков;
  - список проблемных колонок;
  - ключевые флаги качества (дубликаты, константные колонки, высокая кардинальность и т.д.).

**Пример запуска:**

Базовый отчёт на учебном датасете:

```bash
uv run eda-cli report data/example.csv --out-dir reports_example
```

Отчёт с кастомными параметрами:

```bash
uv run eda-cli report data/example.csv \
  --out-dir reports_custom \
  --max-hist-columns 4 \
  --top-k-categories 3 \
  --title "HW03: анализ example.csv" \
  --min-missing-share 0.05 \
  --json-summary
```

**Сгенерированные артефакты (в `out-dir`):**

- `report.md` — текстовый отчёт;
- `histograms.png` — гистограммы числовых признаков;
- `missing_bar.png` — бар‑чарт с количеством пропусков по колонкам (если пропуски есть);
- `boxplots.png` — boxplot‑графики по числовым колонкам (доп. визуализация);
- `category_<имя_колонки>.png` — bar‑чарт top‑значений первой категориальной колонки (доп. визуализация);
- `summary.json` — JSON‑сводка (если был указан `--json-summary`).

---

### 5.3. Команда `head` (доп. часть, вариант A)

Выводит первые `n` строк датасета в табличном виде.

**Синтаксис:**

```bash
uv run eda-cli head PATH --n N [опции]
```

**Параметры:**

- `PATH` — путь к CSV;
- `--n`, `-n` — сколько строк показать (по умолчанию `5`);
- `--sep`, `-s`, `--encoding`, `-e` — формат CSV (аналогично другим командам).

**Пример:**

```bash
uv run eda-cli head data/example.csv --n 5
```

---

### 5.4. Команда `sample` (доп. часть, вариант A)

Выводит случайную выборку строк из датасета.

**Синтаксис:**

```bash
uv run eda-cli sample PATH --n N [--seed SEED] [опции]
```

**Параметры:**

- `PATH` — путь к CSV;
- `--n`, `-n` — количество строк в выборке (по умолчанию `5`);
- `--seed` — фиксированный seed для воспроизводимых выборок (опционально);
- `--sep`, `-s`, `--encoding`, `-e` — формат CSV.

**Пример:**

```bash
uv run eda-cli sample data/example.csv --n 3 --seed 42
```

---

## 6. Эвристики качества данных

Основная логика анализа реализована в `src/eda_cli/core.py` (функция `compute_quality_flags`). Возвращается словарь с набором флагов и вспомогательной информацией.

### Базовые проверки

- `has_high_missing` — присутствуют ли колонки с долей пропусков выше заданного порога;
- `high_missing_columns` — список таких колонок;
- `has_duplicates` — есть ли дублирующиеся строки;
- `duplicate_count` — количество дубликатов.

### Новые эвристики (добавлены в HW03)

- `has_constant_columns`  
  Есть ли колонки, в которых все значения одинаковые (одна уникальная категория/число).  
  Доп. поля:  
  - `constant_columns` — список константных колонок.

- `has_high_cardinality_categoricals`  
  Категориальные признаки с очень большим числом уникальных значений (порог задаётся параметром `high_cardinality_threshold`).  
  Доп. поля:  
  - `high_cardinality_columns` — список колонок с высокой кардинальностью.

- `has_many_zero_values`  
  Для числовых колонок считается доля нулевых значений; если она выше порога `zero_threshold`, колонка считается «подозрительной».  
  Доп. поля:  
  - `high_zero_columns` — список таких колонок;  
  - `zero_shares` — словарь долей нулей по числовым колонкам.

### Интегральная метрика

В словарь также добавляется:

- `quality_score` — интегральный показатель качества (0–100), который штрафуется за:
  - высокую долю пропусков,
  - дубликаты,
  - константные колонки,
  - высокую кардинальность категориальных признаков,
  - большую долю нулей.

В отчёте `report.md` `quality_score` выводится в разделе «Качество данных».

---

## 7. Тесты

Модульные тесты лежат в `tests/test_core.py`. Покрываются:

- загрузка CSV (`load_csv`);
- базовая статистика (`get_basic_stats`);
- информация о пропусках (`get_missing_info`);
- эвристики качества (`compute_quality_flags`):
  - дубликаты;
  - константные колонки;
  - высокая кардинальность;
  - большое количество нулей;
  - расчёт `quality_score`;
- определение проблемных колонок по пропускам (`get_problematic_columns`).

**Запуск тестов:**

```bash
cd homeworks/HW03/eda-cli
uv run pytest -v
```

или краткий вариант:

```bash
uv run pytest -q
```

---

## 8. Примеры типичного сценария

1. Установка зависимостей:

   ```bash
   cd homeworks/HW03/eda-cli
   uv sync
   ```

2. Быстрый обзор учебного датасета:

   ```bash
   uv run eda-cli overview data/example.csv
   ```

3. Генерация отчёта по умолчанию:

   ```bash
   uv run eda-cli report data/example.csv --out-dir reports_example
   ```

4. Расширенный отчёт с настройками и JSON‑сводкой:

   ```bash
   uv run eda-cli report data/example.csv \
     --out-dir reports_custom \
     --max-hist-columns 4 \
     --top-k-categories 3 \
     --title "HW03: пример отчёта" \
     --min-missing-share 0.05 \
     --json-summary
   ```

5. Просмотр «шапки» и случайной выборки:

   ```bash
   uv run eda-cli head data/example.csv --n 5
   uv run eda-cli sample data/example.csv --n 3 --seed 42
   ```

После этого можно открыть `reports_example/report.md` или `reports_custom/report.md` в любом Markdown‑просмотрщике и просмотреть сгенерированные графики в той же папке.

---

## 9. Структура модулей

### `src/eda_cli/core.py`

Основная логика анализа:

- `load_csv()` — загрузка CSV;
- `get_basic_stats()` — базовая статистика;
- `get_missing_info()` — информация о пропусках;
- `get_numeric_summary()` — статистика по числовым колонкам;
- `get_categorical_summary()` — статистика по категориальным колонкам;
- `compute_quality_flags()` — вычисление флагов и метрик качества (включая новые эвристики);
- `get_problematic_columns()` — список колонок выше порога пропусков.

### `src/eda_cli/viz.py`

Визуализация:

- `save_histograms()` — гистограммы для числовых колонок;
- `save_missing_bar()` — график пропусков;
- `save_boxplots()` — boxplot‑графики (доп. визуализация);
- `save_category_bar()` — bar‑chart для категориального признака (доп. визуализация).

### `src/eda_cli/cli.py`

CLI интерфейс на `typer`:

- `overview()` — команда обзора;
- `report()` — команда генерации отчёта (с новыми параметрами);
- `head()` — команда вывода первых N строк;
- `sample()` — команда вывода случайной выборки.

### `tests/test_core.py`

Набор модульных тестов `pytest` для функций из `core.py`.

---

## 10. Зависимости

Проект использует:

- **pandas** (≥2.0.0) — работа с табличными данными;
- **matplotlib** (≥3.7.0) — построение графиков;
- **typer** (≥0.9.0) — создание CLI;
- **rich** (≥13.0.0) — красивый вывод в консоль;
- **pytest** (≥7.0.0) — тестирование (dev‑зависимость).

Все зависимости управляются через `uv` и зафиксированы в `uv.lock`.

---


## 11. Проверка работоспособности

```bash
cd homeworks/HW03/eda-cli

# Установка
uv sync

# Тестирование
uv run pytest -v

# Примеры команд
uv run eda-cli overview data/example.csv
uv run eda-cli report data/example.csv --out-dir reports_example
uv run eda-cli head data/example.csv --n 5
uv run eda-cli sample data/example.csv --n 3 --seed 42
```

Все команды должны выполниться без ошибок, тесты должны пройти успешно.
